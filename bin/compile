#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

# fail fast
set -euo pipefail

BPLOG_PREFIX="buildpack.gradle"

BUILDPACK_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && cd .. && pwd)"

# parse args
BUILD_DIR="${1}"
CACHE_DIR="${2}"
ENV_DIR="${3}"

source "${BUILDPACK_DIR}/lib/common.sh"
source "${BUILDPACK_DIR}/lib/failures.sh"
source "${BUILDPACK_DIR}/lib/output.sh"
source "${BUILDPACK_DIR}/lib/util.sh"
source "${BUILDPACK_DIR}/lib/openjdk.sh"
source "${BUILDPACK_DIR}/lib/frameworks.sh"
source "${BUILDPACK_DIR}/lib/metrics.sh"

metrics::init "${CACHE_DIR}" "gradle"
metrics::setup

util::export_env_dir "${ENV_DIR}" "." "JAVA_OPTS|JAVA_TOOL_OPTIONS"

if [ -z "${GRADLE_TASK:-}" ]; then
	if has_stage_task "${BUILD_DIR}"; then
		GRADLE_TASK="stage"
	elif frameworks::is_spring_boot "${BUILD_DIR}"; then
		GRADLE_TASK="build -x check"
	elif frameworks::is_micronaut "${BUILD_DIR}"; then
		GRADLE_TASK="shadowJar -x check"
	elif frameworks::is_quarkus "${BUILD_DIR}"; then
		GRADLE_TASK="build -x check"
	elif frameworks::is_ratpack "${BUILD_DIR}"; then
		GRADLE_TASK="installDist -x check"
	else
		GRADLE_TASK="stage"
	fi
fi

openjdk::install_openjdk_via_jvm_common_buildpack "${BUILD_DIR}" "${BUILDPACK_DIR}"

export GRADLE_OPTS="${GRADLE_OPTS:-}${GRADLE_OPTS:+ }-Dorg.gradle.daemon=false -Dorg.gradle.internal.launcher.welcomeMessageEnabled=false"

mkdir -p "${CACHE_DIR}/.gradle"
export GRADLE_USER_HOME="${GRADLE_USER_HOME:-${CACHE_DIR}/.gradle}"

create_project_cache_symlink "${CACHE_DIR}" "${BUILD_DIR}"

if [ ! -f "${BUILD_DIR}/gradlew" ] ; then
	output::error <<-EOF
		Error: Gradle Wrapper is missing.

		The Gradle wrapper (gradlew) is required to build your application on Heroku.
		This ensures that your application builds with the same version of Gradle
		that you use during development.

		To fix this issue, run this command in your project directory
		locally and commit the generated files:
		$ gradle wrapper

		If you don't have Gradle installed locally, you can install it first:
		https://gradle.org/install/

		For more information about Gradle Wrapper, see:
		https://docs.gradle.org/current/userguide/gradle_wrapper.html
	EOF

	metrics::set_string "failure_reason" "gradle_wrapper::missing"
	exit 1
fi
BUILDCMD="./gradlew"
chmod +x "${BUILD_DIR}/gradlew"

BUILDCMD="${BUILDCMD} ${GRADLE_TASK}"

cd "${BUILD_DIR}"


# build app
output::step "Building Gradle app..."
echo "-----> executing ${BUILDCMD}" | output::indent

buildLogFile=".heroku/gradle-build.log"
echo "" > "${buildLogFile}"

${BUILDCMD} 2>&1 | output "${buildLogFile}"

if [ "${PIPESTATUS[*]}" != "0 0" ]; then
	handle_gradle_errors "${buildLogFile}"
fi

# https://github.com/heroku/heroku-buildpack-gradle/issues/49
rm -rf "${CACHE_DIR}/.gradle/nodejs"
